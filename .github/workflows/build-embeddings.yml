name: Build Semantic Embeddings

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-embeddings:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests sentence-transformers torch

      - name: Download catalog
        run: python scripts/download_adafruit_catalog.py

      - name: Generate embeddings
        run: |
          python scripts/generate_embeddings.py \
            --in data/raw/adafruit_catalog.json \
            --out data/processed/embeddings.json \
            --model sentence-transformers/all-MiniLM-L6-v2
          python - <<'PY'
          import json
          with open("data/processed/embeddings.json", "r", encoding="utf-8") as f:
              payload = json.load(f)
          model = payload.get("model", "unknown")
          count = len(payload.get("items", []))
          print(f"MODEL_NAME={model}")
          print(f"EMBEDDING_COUNT={count}")
          with open("embeddings_meta.env", "w", encoding="utf-8") as out:
              out.write(f"MODEL_NAME={model}\n")
              out.write(f"EMBEDDING_COUNT={count}\n")
          PY
      - name: Load embeddings metadata
        id: embeddings_meta
        run: |
          set -a
          . ./embeddings_meta.env
          set +a
          echo "model=$MODEL_NAME" >> "$GITHUB_OUTPUT"
          echo "count=$EMBEDDING_COUNT" >> "$GITHUB_OUTPUT"

      - name: Upload embeddings artifact
        uses: actions/upload-artifact@v4
        with:
          name: adafruit-embeddings
          path: data/processed/embeddings.json
          if-no-files-found: error

      - name: Set release tag
        id: release_tag
        run: echo "tag=embeddings-$(date -u +%Y-%m)" >> "$GITHUB_OUTPUT"

      - name: Publish embeddings prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.release_tag.outputs.tag }}
        run: |
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Updating existing release $TAG"
          else
            gh release create "$TAG" \
              --title "$TAG" \
              --prerelease \
              --notes "Automated embeddings build for $TAG.\n\nModel: ${{ steps.embeddings_meta.outputs.model }}\nItems: ${{ steps.embeddings_meta.outputs.count }}"
          fi
          gh release upload "$TAG" data/processed/embeddings.json --clobber
